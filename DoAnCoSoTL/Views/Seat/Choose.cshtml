<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
@{
    ViewData["Title"] = "Choose Seat";
}

<h2>Choose Seat</h2>
<p>Screening ID: @ViewData["ScreeningId"]</p>
<p>Time Slot: @ViewData["TimeSlot"]</p>
<div id="ticketPrice">Giá vé: $@ViewBag.TicketPrice</div>

<a href="javascript:history.back()">Trở về</a>

<div class="screen-divider">
    <hr class="divider-line">
    <div class="screen-text">Màn hình</div>
</div>

<div class="seat-layout">
    @for (int row = 1; row <= 8; row++)
    {
        <div class="seat-row">
            @for (int seatNumber = 1; seatNumber <= 12; seatNumber++)
            {
                var seatId = (row - 1) * 12 + seatNumber;
                var isBooked = Model != null && Model.Contains(seatId); // Kiểm tra xem Model có null hay không trước khi sử dụng

                <button class="seat @(isBooked ? "gray" : "")" @(isBooked ? "disabled" : "")>
                    <span class="seat-text">@($"{(char)('A' + row - 1)}{seatNumber}")</span>
                </button>
            }
        </div>
    }
</div>

<div class="legend" style="margin-bottom: 20px;">
    <div class="legend-item">
        <div class="seat-legend pink"></div>
        <span>Ghế đã chọn</span>
    </div>
    <div class="legend-item">
        <div class="seat-legend white"></div>
        <span>Ghế trống</span>
    </div>
    <div class="legend-item">
        <div class="seat-legend gray"></div>
        <span>Ghế đã được đặt</span>
    </div>
</div>

<div id="selectedSeats">Số ghế đã chọn:</div> <!-- Phần tử để hiển thị số ghế đã chọn -->
<form asp-controller="Seat" asp-action="BookTicket" method="post">
    <input type="hidden" name="screeningId" value="@ViewData["ScreeningId"]" />
    <input type="hidden" name="timeSlot" value="@ViewData["TimeSlot"]" />
    @foreach (var seat in Model)
    {
        <input type="hidden" name="selectedSeatIds[]" value="@seat.Id" />
    }
    <button type="submit" class="btn btn-primary">Mua vé</button>
</form>
<div id="totalPrice">Tổng tiền: $0</div>

<script>
    $(document).ready(function () {
        $('.seat').click(function () {
            var isSelected = $(this).hasClass('selected');

            // Kiểm tra xem nút đã được chọn trước đó chưa
            if (!isSelected) {
                // Nếu chưa được chọn, thêm lớp 'selected' để chuyển màu nền thành màu hồng
                $(this).addClass('selected');
            } else {
                // Nếu đã được chọn, xóa lớp 'selected' để trở về màu nền mặc định
                $(this).removeClass('selected');
            }
            // Cập nhật tổng tiền khi người dùng chọn hoặc bỏ chọn ghế
            updateTotalPrice();
            updateSelectedSeats(); // Cập nhật số ghế đã chọn
        });

        function updateTotalPrice() {
            // Đếm số lượng ghế đã chọn
            var selectedSeatCount = $('.seat.selected').length;

            // Lấy giá vé từ dữ liệu được truyền từ server (phải đảm bảo rằng giá vé đã được gửi đến view)
            var ticketPrice = @ViewBag.TicketPrice; // Điều này giả sử rằng giá vé được truyền từ ViewBag

            // Tính tổng tiền
            var totalPrice = selectedSeatCount * ticketPrice;

            // Cập nhật nội dung của phần tử HTML hiển thị tổng tiền
            $('#totalPrice').text('Tổng tiền: $' + totalPrice.toFixed(2));
        }

        function updateSelectedSeats() {
            var selectedSeats = [];
            $('.seat.selected').each(function () {
                var seatText = $(this).find('.seat-text').text(); // Lấy nội dung của ghế đã chọn
                selectedSeats.push(seatText); // Thêm vào mảng các ghế đã chọn
            });

            // Cập nhật nội dung của phần tử HTML hiển thị số ghế đã chọn
            $('#selectedSeats').text('Số ghế đã chọn: ' + selectedSeats.join(', '));
        }
        function redirectToTicketDetails() {
            // Lấy số ghế đã chọn
            var selectedSeatIds = [];
            $('.seat.selected').each(function () {
                var seatText = $(this).find('.seat-text').text();
                selectedSeatIds.push(seatText);
            });

            // Lấy tổng tiền
            var totalPrice = parseFloat($('#totalPrice').text().replace('Tổng tiền: $', ''));

            // Chuyển hướng đến trang TicketDetails với các tham số
            window.location.href = '/Seat/TicketDetails?selectedSeatIds=' + selectedSeatIds.join(',') + '&totalPrice=' + totalPrice;
        }
    });
</script>

<style>
    .seat-layout {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .seat-row {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .row-number {
        width: 30px;
        text-align: center;
    }

    .seat {
        width: 40px; /* Độ rộng của button */
        height: 40px; /* Độ cao của button */
        border: 1px solid #000;
        background-color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

        .seat:hover {
            background-color: #add8e6;
        }

        .seat.selected {
            background-color: pink; /* Đặt màu hồng cho nút đã được chọn */
        }

    .seat-text {
        font-size: 16px; /* Kích thước font của chữ trong button */
    }

    .screen-divider {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .divider-line {
        width: 200px; /* Đặt độ rộng mong muốn của thanh ngang */
        border: none;
        border-top: 2px solid black;
        margin-top: 10px;
    }

    .screen-text {
        font-weight: bold;
        margin-top: -30px; /* Điều chỉnh margin-top để chữ "Màn hình" nằm gần sát thanh ngang */
        margin-bottom: 30px;
    }

    .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }

    .legend-item {
        display: flex;
        gap: 10px;
    }

    .seat-legend {
        width: 20px;
        height: 20px;
        border: 1px solid #000;
    }

        .seat-legend.pink {
            background-color: pink;
        }

        .seat-legend.white {
            background-color: #fff;
        }

        .seat-legend.gray {
            background-color: gray;
        }
</style>
